# ComfyUI 工作流保存 405 错误解决方案

## 问题描述
ComfyUI 保存工作流时报错：
```
Error storing user data file 'workflows/image_z_image_turbo.json': 405
```

## 根本原因
ComfyUI 的 `/api/userdata` 端点返回 405 错误，说明该 API 不支持 POST/PUT 方法，或者目录权限问题。

## 已尝试的方案

### 方案 1：软链接（失败）
```python
# 创建软链接到持久化存储
subprocess.run("ln -sf /cache/comfyui_user /root/comfy/ComfyUI/user", shell=True)
```
**结果**：405 错误依然存在，说明不是文件系统权限问题。

### 方案 2：命令行参数（当前尝试）
```python
subprocess.Popen(
    "comfy launch -- --listen 0.0.0.0 --port 8000 --user-directory /cache/comfyui_user --output-directory /cache/comfyui_output",
    shell=True
)
```
**状态**：待验证 ComfyUI 是否支持这些参数。

## 可能的解决方案

### 方案 3：禁用工作流保存功能
如果 ComfyUI 不支持配置用户目录，可以：
1. 在前端禁用"保存工作流"按钮
2. 提示用户使用"导出工作流"功能（下载到本地）
3. 使用 API 模式，不依赖 Web UI 的工作流保存

### 方案 4：修改 ComfyUI 源码
在镜像构建时修改 ComfyUI 的 API 端点，启用 userdata 写入：
```python
.run_commands(
    "cd /root/comfy/ComfyUI && "
    "sed -i 's/methods=\\[\"GET\"\\]/methods=[\"GET\", \"POST\", \"PUT\"]/' server.py"
)
```

### 方案 5：使用环境变量
检查 ComfyUI 是否支持环境变量配置：
```python
.env({
    "COMFYUI_USER_DIR": "/cache/comfyui_user",
    "COMFYUI_OUTPUT_DIR": "/cache/comfyui_output"
})
```

## 当前配置
```python
# Volume 挂载
volumes={"/cache": vol}

# 缓存目录
cache_dir="/cache"

# 启动命令
comfy launch -- --listen 0.0.0.0 --port 8000 --user-directory /cache/comfyui_user --output-directory /cache/comfyui_output
```

## 建议
1. 先测试方案 2（命令行参数）
2. 如果失败，使用方案 3（禁用保存，改用导出）
3. 长期方案：联系 ComfyUI 开发者，请求支持配置用户目录
