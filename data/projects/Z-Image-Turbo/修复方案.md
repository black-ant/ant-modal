# Modal Volume 挂载修复方案

## 问题
Modal 不允许挂载 Volume 到以下路径：
- `/root` - 系统保留目录
- `/tmp` - 临时目录

## 解决方案
使用 `/data` 作为 Volume 挂载点，然后通过软链接连接到 ComfyUI 目录。

## 实现方式

### 1. 构建阶段（下载模型）
```python
.run_function(
    hf_download,
    volumes={"/data": vol},  # 挂载到 /data
    secrets=[hf_secret] if hf_secret else []
)
```

在 `hf_download()` 函数中：
```python
cache_dir="/data/cache"  # HuggingFace 缓存目录
```

### 2. 运行阶段（UI 服务）
```python
@app.function(
    volumes={"/data": vol},  # 挂载到 /data
    ...
)
def ui():
    # 创建必要的目录
    Path("/data/output").mkdir(parents=True, exist_ok=True)
    Path("/data/user").mkdir(parents=True, exist_ok=True)
    
    # 创建软链接
    subprocess.run("ln -sf /data/output /root/comfy/ComfyUI/output", shell=True)
    subprocess.run("ln -sf /data/user /root/comfy/ComfyUI/user", shell=True)
```

## 目录结构

```
/data/                          # Volume 挂载点
├── cache/                      # HuggingFace 模型缓存
│   └── huggingface/
│       └── hub/
├── output/                     # ComfyUI 输出文件
└── user/                       # ComfyUI 用户数据
    └── default/
        └── workflows/          # 工作流保存位置

/root/comfy/ComfyUI/
├── models/                     # 模型目录（软链接到 /data/cache）
├── output -> /data/output      # 软链接
└── user -> /data/user          # 软链接
```

## 优点
1. ✅ 符合 Modal 的限制
2. ✅ 持久化所有用户数据
3. ✅ 模型和输出文件都保存在 Volume 中
4. ✅ 容器重启后数据不丢失
