# ComfyUI 卷映射修复说明

## 问题描述
保存工作流时出现 405 错误：
```
Error storing user data file 'workflows/image_z_image_turbo.json': 405
```

## 根本原因
ComfyUI 需要保存工作流到 `user/default/workflows/` 目录，但部署配置中缺少对应的卷映射。容器重启后这些目录会丢失，导致 ComfyUI API 无法写入文件。

## 解决方案
将 Volume 挂载到 `/root` 目录，这样可以持久化整个 ComfyUI 工作目录：

```python
volumes={"/root": vol}  # 挂载到 /root，包含所有 ComfyUI 数据
```

同时在 `ui()` 函数中确保目录存在：
```python
Path("/root/comfy/ComfyUI/user/default/workflows").mkdir(parents=True, exist_ok=True)
```

**注意：** Modal 不允许同一个 Volume 挂载到多个路径，所以使用单一挂载点 `/root` 来覆盖所有需要持久化的数据。

## 额外修复
1. 将 `container_idle_timeout` 改为 `scaledown_window`（Modal 1.0 新参数名）
2. 所有文件都设置为 10 分钟无请求后自动关闭，节省成本

## 已修复的文件

### 项目文件
1. `data/projects/Z-Image-Turbo/z_image_turbo_deploy.py`
2. `data/projects/SVD 1.1/svd_deploy.py`
3. `data/projects/Wan 2.1 文生视频/wan21_t2v_deploy.py`

### 模板文件
1. `data/templates/z-image-turbo/z_image_turbo_deploy.py`
2. `data/templates/wan21-t2v/wan21_t2v_deploy.py`
3. `data/templates/comfy-video-gen/wan21_t2v_deploy.py`
4. `data/templates/comfy-video-gen/wan22_i2v_deploy.py`

## 重新部署
修复后需要重新部署应用：
```bash
modal deploy data/projects/Z-Image-Turbo/z_image_turbo_deploy.py
```

部署后，ComfyUI 就能正常保存工作流，不会再报 405 错误。

