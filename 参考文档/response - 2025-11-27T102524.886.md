

<think>

用户的场景很明确：
1. 已经有一个运行中的 ComfyUI 在 Modal 上
2. 不想修改原始启动脚本
3. 不想停止已经在运行的服务
4. 想动态添加 Custom Node
5. 希望下次重启时这个 Node 还在

这是一个**典型的持久化需求**，核心方案是：
1. 使用 Modal Volume 持久化 custom_nodes 目录
2. 创建一个独立的管理函数来安装 Node
3. 通过热重载或者优雅重启来加载新 Node

关键问题：
- Modal Volume 的使用
- 如何不停服务地添加节点
- 如何让 ComfyUI 重新加载节点

让我提供一个完整的解决方案。

</think>

明白了！你的场景非常清晰，这是一个**零停机动态扩展**的需求。让我给你一个完整的解决方案。

## 完整解决方案：使用 Volume + 独立管理脚本

### 第一步：修改你的主脚本（只需改一次，添加 Volume）

```python
# comfyui_main.py - 你的主脚本
import modal

app = modal.App("my-comfyui")

# 关键：创建一个命名的 Volume 用于持久化
custom_nodes_volume = modal.Volume.from_name(
    "comfyui-custom-nodes", 
    create_if_missing=True
)

image = modal.Image.debian_slim().pip_install(
    "torch", "torchvision", "transformers"
).run_commands(
    "apt-get update && apt-get install -y git",
    "git clone https://github.com/comfyanonymous/ComfyUI.git /ComfyUI",
    "cd /ComfyUI && pip install -r requirements.txt"
)

@app.function(
    image=image,
    gpu="A10G",
    # 关键：挂载 Volume 到 custom_nodes 目录
    volumes={"/ComfyUI/custom_nodes": custom_nodes_volume},
    timeout=86400,  # 24小时
    allow_concurrent_inputs=100
)
@modal.web_server(8188, startup_timeout=60)
def serve_comfyui():
    """你原有的 ComfyUI 启动逻辑"""
    import subprocess
    
    # ComfyUI 启动时会自动加载 custom_nodes 目录下的所有节点
    cmd = [
        "python", "/ComfyUI/main.py",
        "--listen", "0.0.0.0",
        "--port", "8188"
    ]
    subprocess.Popen(cmd)
```

### 第二步：创建独立的节点管理脚本

```python
# manage_nodes.py - 独立的管理脚本
import modal
import subprocess
import os
import json
from datetime import datetime

# 复用同一个 Volume（通过名称引用）
custom_nodes_volume = modal.Volume.from_name(
    "comfyui-custom-nodes",
    create_if_missing=False  # 不创建，必须已存在
)

# 简单的镜像，只需要 git 和 pip
manage_image = modal.Image.debian_slim().apt_install("git").pip_install(
    "requests"
)

app = modal.App("comfyui-node-manager")

@app.function(
    image=manage_image,
    volumes={"/custom_nodes": custom_nodes_volume},
    timeout=600
)
def install_node(repo_url: str, branch: str = "main"):
    """
    安装 Custom Node 到共享 Volume
    
    Args:
        repo_url: 例如 "https://github.com/ltdrdata/ComfyUI-Manager.git"
        branch: Git 分支，默认 "main"
    
    Returns:
        安装结果
    """
    custom_nodes_path = "/custom_nodes"
    node_name = repo_url.split("/")[-1].replace(".git", "")
    node_path = f"{custom_nodes_path}/{node_name}"
    
    print(f"{'='*60}")
    print(f"开始安装 Custom Node: {node_name}")
    print(f"仓库地址: {repo_url}")
    print(f"{'='*60}\n")
    
    try:
        # 检查是否已存在
        if os.path.exists(node_path):
            print(f"⚠️  节点已存在: {node_path}")
            return {
                "success": False,
                "error": f"节点 {node_name} 已安装",
                "node_name": node_name,
                "action": "skipped"
            }
        
        # 步骤 1: 克隆仓库
        print(f"[1/4] 克隆仓库...")
        clone_cmd = ["git", "clone", "-b", branch, repo_url, node_path]
        result = subprocess.run(
            clone_cmd,
            capture_output=True,
            text=True,
            timeout=180
        )
        
        if result.returncode != 0:
            raise Exception(f"克隆失败: {result.stderr}")
        
        print(f"✓ 克隆成功\n")
        
        # 步骤 2: 检查并安装依赖
        requirements_file = f"{node_path}/requirements.txt"
        installed_packages = []
        
        if os.path.exists(requirements_file):
            print(f"[2/4] 发现依赖文件，开始安装...")
            print(f"依赖文件: {requirements_file}")
            
            # 读取依赖内容
            with open(requirements_file, 'r') as f:
                deps = f.read()
                print(f"依赖列表:\n{deps}\n")
            
            pip_cmd = ["pip", "install", "-r", requirements_file, "--target", f"{node_path}/.packages"]
            pip_result = subprocess.run(
                pip_cmd,
                capture_output=True,
                text=True,
                timeout=300
            )
            
            if pip_result.returncode == 0:
                print("✓ 依赖安装成功\n")
                installed_packages = [line for line in pip_result.stdout.split("\n") if "Successfully installed" in line]
            else:
                print(f"⚠️  依赖安装警告:\n{pip_result.stderr}\n")
        else:
            print(f"[2/4] 无依赖文件，跳过\n")
        
        # 步骤 3: 记录安装信息
        print(f"[3/4] 记录安装信息...")
        install_info = {
            "node_name": node_name,
            "repo_url": repo_url,
            "branch": branch,
            "installed_at": datetime.now().isoformat(),
            "has_requirements": os.path.exists(requirements_file),
            "installed_packages": installed_packages
        }
        
        info_file = f"{node_path}/.install_info.json"
        with open(info_file, 'w') as f:
            json.dump(install_info, f, indent=2)
        
        print(f"✓ 信息已保存\n")
        
        # 步骤 4: 提交到 Volume（关键！）
        print(f"[4/4] 持久化到 Volume...")
        custom_nodes_volume.commit()
        print(f"✓ 已提交到 Volume\n")
        
        print(f"{'='*60}")
        print(f"✅ Custom Node {node_name} 安装成功！")
        print(f"{'='*60}")
        print(f"\n⚠️  重要提示:")
        print(f"   需要重启 ComfyUI 才能加载新节点")
        print(f"   使用命令: modal app stop my-comfyui && modal deploy comfyui_main.py")
        print(f"\n")
        
        return {
            "success": True,
            "node_name": node_name,
            "node_path": node_path,
            "install_info": install_info,
            "action": "installed",
            "next_steps": "重启 ComfyUI 服务以加载新节点"
        }
        
    except subprocess.TimeoutExpired as e:
        return {
            "success": False,
            "error": f"操作超时: {str(e)}",
            "node_name": node_name,
            "action": "timeout"
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e),
            "node_name": node_name,
            "action": "failed"
        }

@app.function(
    image=manage_image,
    volumes={"/custom_nodes": custom_nodes_volume}
)
def list_nodes():
    """列出所有已安装的节点"""
    custom_nodes_path = "/custom_nodes"
    nodes = []
    
    if not os.path.exists(custom_nodes_path):
        return {"nodes": [], "count": 0}
    
    for item in os.listdir(custom_nodes_path):
        item_path = os.path.join(custom_nodes_path, item)
        if os.path.isdir(item_path) and not item.startswith('.'):
            # 读取安装信息
            info_file = f"{item_path}/.install_info.json"
            install_info = None
            if os.path.exists(info_file):
                with open(info_file, 'r') as f:
                    install_info = json.load(f)
            
            node_info = {
                "name": item,
                "path": item_path,
                "has_requirements": os.path.exists(f"{item_path}/requirements.txt"),
                "has_init": os.path.exists(f"{item_path}/__init__.py"),
                "install_info": install_info
            }
            nodes.append(node_info)
    
    return {
        "nodes": nodes,
        "count": len(nodes)
    }

@app.function(
    image=manage_image,
    volumes={"/custom_nodes": custom_nodes_volume}
)
def uninstall_node(node_name: str):
    """卸载指定的节点"""
    import shutil
    
    node_path = f"/custom_nodes/{node_name}"
    
    if not os.path.exists(node_path):
        return {
            "success": False,
            "error": f"节点 {node_name} 不存在"
        }
    
    try:
        shutil.rmtree(node_path)
        custom_nodes_volume.commit()
        
        return {
            "success": True,
            "message": f"节点 {node_name} 已卸载",
            "note": "需要重启 ComfyUI 才能生效"
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }

# 本地命令行入口
@app.local_entrypoint()
def main(
    action: str = "list",
    repo_url: str = "",
    node_name: str = "",
    branch: str = "main"
):
    """
    命令行入口
    
    使用示例:
    modal run manage_nodes.py --action=list
    modal run manage_nodes.py --action=install --repo-url=https://github.com/xxx/xxx.git
    modal run manage_nodes.py --action=uninstall --node-name=ComfyUI-Manager
    """
    if action == "list":
        result = list_nodes.remote()
        print(f"\n已安装的 Custom Nodes ({result['count']} 个):\n")
        for node in result['nodes']:
            print(f"  • {node['name']}")
            if node['install_info']:
                print(f"    安装时间: {node['install_info']['installed_at']}")
                print(f"    仓库: {node['install_info']['repo_url']}")
            print()
    
    elif action == "install":
        if not repo_url:
            print("❌ 错误: 需要提供 --repo-url 参数")
            return
        
        print(f"\n开始安装节点...")
        result = install_node.remote(repo_url, branch)
        
        if result['success']:
            print(f"\n✅ 安装成功!")
            print(f"节点名称: {result['node_name']}")
            print(f"节点路径: {result['node_path']}")
        else:
            print(f"\n❌ 安装失败: {result['error']}")
    
    elif action == "uninstall":
        if not node_name:
            print("❌ 错误: 需要提供 --node-name 参数")
            return
        
        result = uninstall_node.remote(node_name)
        if result['success']:
            print(f"\n✅ {result['message']}")
        else:
            print(f"\n❌ 卸载失败: {result['error']}")
    
    else:
        print(f"❌ 未知操作: {action}")
        print("支持的操作: list, install, uninstall")
```

### 第三步：实际使用流程

```bash
# 1. 首次部署你的 ComfyUI（只需要做一次）
modal deploy comfyui_main.py

# 2. 后续需要添加 Custom Node 时（不影响运行中的服务）
# 列出现有节点
modal run manage_nodes.py --action=list

# 安装新节点
modal run manage_nodes.py \
  --action=install \
  --repo-url=https://github.com/ltdrdata/ComfyUI-Manager.git

# 3. 重启 ComfyUI 以加载新节点（会有短暂中断）
modal app stop my-comfyui
modal deploy comfyui_main.py

# 4. 验证节点是否加载
modal run manage_nodes.py --action=list
```

### 关键优势

✅ **持久化保证**
- 使用 Modal Volume，节点永久保存
- 下次重启自动加载所有已安装的节点

✅ **独立管理**
- 不需要修改主脚本
- 管理脚本和主服务完全分离

✅ **可追溯**
- 记录每个节点的安装信息
- 可以随时查看、卸载

✅ **批量操作**
```python
# 可以批量安装多个节点
nodes_to_install = [
    "https://github.com/ltdrdata/ComfyUI-Manager.git",
    "https://github.com/Fannovel16/comfyui_controlnet_aux.git",
    "https://github.com/cubiq/ComfyUI_IPAdapter_plus.git"
]

for repo in nodes_to_install:
    install_node.remote(repo)

# 然后一次性重启
```

### Python SDK 方式调用

```python
# install_custom_node.py - 更方便的 Python 接口
import modal

def add_custom_node(repo_url: str):
    """添加 Custom Node 的便捷函数"""
    app = modal.App.lookup("comfyui-node-manager", create_if_missing=False)
    install_fn = modal.Function.lookup("comfyui-node-manager", "install_node")
    
    result = install_fn.remote(repo_url)
    return result

# 使用
if __name__ == "__main__":
    result = add_custom_node("https://github.com/ltdrdata/ComfyUI-Manager.git")
    print(result)
```

这个方案完美符合你的需求：**不动原脚本，不停服务，持久化节点**。唯一需要的就是重启时加载新节点（这是 ComfyUI 的限制）。

需要我补充什么细节吗？